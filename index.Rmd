---
title: "Portfolio Computational Musicology"
author: "Eliza"
date: "spring 2023"
output: 
  flexdashboard::flex_dashboard:
    self_contained: false
    theme: simplex
    vertical_layout: fill
    horizontal_layout: scroll
---

```{r}
library(tidyverse)
library(spotifyr)
library(compmus)
library(plotly)
```

```{r}
Top1999 <- get_playlist_audio_features("", "0qSHbyaiZbhacDdIegMoBR")
Top2009 <- get_playlist_audio_features("", "6BJbzcSvOunQpVCJuBLxEW")
Top2019 <- get_playlist_audio_features("", "1MaaUHHVuXbmrDhoUCDDcL")
Top2022 <- get_playlist_audio_features("", "4U5UXciYphLDZAIgjdz50v")

Top2000lists <-
  bind_rows(
    Top1999 |> mutate(category = "1999"),
    Top2009 |> mutate(category = "2009"),
    Top2019 |> mutate(category = "2019"),
    Top2022 |> mutate(category = "2022")
  )
```

```{r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
```

NEW {.storyboard}
===================================================

### Rainbow in the Sky {.storyboard}
```{r}
Rainbow <- get_tidy_audio_analysis("2MlqP1HzhitHfFXPXKumdB")

Rainbow |>
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) |>
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()
```

***
**What is a tempogram?**

A tempogram shows the BPM of a song over time. In this case the yellow lines show the BPM at a certain point in the song. Sometimes there is more than one yellow line visible, these 'extra' lines are tempo octaves.

**The tempogram of Rainbow in the Sky**

This is a tempogram of Rainbow in the Sky by DJ Paul Elstak. The tempogram shows a straight line throughtout the entire song around 360 BPM. At around 10 seconds and 75 seconds there are other yellow dots visible for 180 BPM, these are the tempo octaves. At 120 and 150 seconds there are also 'extra' short yellow lines in the tempogram. I personally don't have a good explanation for these lines that appear around 210 BPM. Rainbow in the Sky is an electronic track in the genre of happy hardcore. This explains the straight line in the tempogram, the electronically created beats happen in a very steady pace.

**Rainbow in the Sky in the TOP2000**

Rainbow in the Sky was released in 1995 but only entered the TOP2000 in 2015 at no. 765. Since, the song has been gaining a few places each year. Last edition, in 2022, the song ended up at the highest position yet, no. 366.

Positions of the song:

1999: -, 2009: -, 2019: no. 386, 2022: no. 366

### Killing in the Name {.storyboard}
```{r}
Killing <- get_tidy_audio_analysis("59WN2psjkt1tyaxjspN8fp")

Killing |>
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) |>
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()
```

***
**The tempogram of Killing in the Name**

The tempogram of Killing in the Name by the band Rage Against the Machine looks very different compared to Rainbow in the Sky's tempogram. In this tempogram there is no straight yellow line. This means a few things. Firstly, Killing in the Name isn't an electronic track like Rainbow in the Sky. This means that the drummer needs to keep the exact same pace for some time, which can be hard. That makes the tempo in Killing in the Name automatically more dynamic and the yellow lines not as straight. A second reason for the bumpy lines could be the noise in the song. Everything in the song comes across as loud, the singing (or one could say almost screaming) and the lead guitar that has several solos for example. These parts don't have a very clear on beat tempo which might interfere with the tempo of the drums. The final reason for why there isn't a straight line, are the tempo changes. These changes are quite obvious when you listen to the song. A clear example of one of these changes is at 2 min. 25 (145 seconds). The song switches here from the chorus to the second verse. The chorus has strong vocals and a heavy guitar with a slightly faster beat than the verse which has the characteristic guitar riff with softer vocals.

**Killing in the Name in the TOP2000**

Just like Rainbow in the Sky, Killing in the Name was released (in 1992) many years before its introduction to the TOP2000 in 2011. Although the song entered at a relatively low position (no. 1454), the song has kept a steady position in the years following: ranging between no. 94 and no. 48. 

Positions of the song:

1999: -, 2009: -, 2019: no. 60, 2022: no. 48

What is the TOP2000?
===================================================

Column {data-width=500}
---------------------------------------------------

### What is the TOP2000?

**"The list of lists"**

The TOP2000 is a Dutch radio programme by radio station NPO radio 2. From Christmas Day until midnight of New Year's Eve, a list of 2000 songs that are considered the "most popular songs of all time", is broadcasted. The list, constructed by votes from the audience, was first on air in 1999 to celebrate the new millennium. Due to the success of the show, the radio station decided to make it an annual programme. In the following years, the TOP2000 grew out to become a yearly tradition for many households.

The list of 2000 songs has changed over the years with new songs entering the TOP2000 and other songs not making it to the final cut. New generations of kids grew up listening to the show with their parents and are voting on their favourite songs now too. This causes more recent hits making it to the list (see statistics [here](https://www.nporadio2.nl/top2000/statistieken)) and most likely making the list conform to its time. What exactly are the differences between the list throughout the years?


**The TOP 2000 of 1999, 2009, 2019 and 2022**

The corpus consists of four playlists: the TOP2000 list from 1999, 2009, and 2019. The 2000 songs that should be included can be found on the NPO radio 2 website. I am using one already existing playlists on Spotify that I have checked on accuracy, the other two playlists I have created myself. Even though the playlists are carefully constructed, there are a few songs missing. This is not the fault of the creator, Spotify simply doesn't have the songs in its library. This results in the list from 1999 containing a total of 1976 songs, 2009 has 1982 songs and the list from 2019 contains 1993 songs. The amount of songs missing is only limited and should therefore not cause too many problems for the data analysis.

An example of a song that is remarkable in the TOP2000 from 2019 is Danny Vera's Rollercoaster. The song entered the list in this year, immediately making it to the 4th place. Ever since it has been in the top 3 which has not happened with other songs before. If we look at the TOP2000 of 1999 it is interesting to see that Avond by Boudewijn de Groot was only placed at 428. The song has grown in popularity because it now has positioned itself on the 8th place.

Column {data-width=250}
---------------------------------------------------

### {data-height=500}
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/0qSHbyaiZbhacDdIegMoBR?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>

### {data-height=500}
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/6BJbzcSvOunQpVCJuBLxEW?utm_source=generator&theme=0" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>

Column {data-width=250}
---------------------------------------------------

### {data-height=500}
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/1MaaUHHVuXbmrDhoUCDDcL?utm_source=generator&theme=0" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>

### {data-height=500}
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/4U5UXciYphLDZAIgjdz50v?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>

Visualisations {.storyboard}
==================================================

### Overview of relation between valence, danceability and mode in TOP 2000 {.storyboard}

```{r}
Top2000_scatter <- Top2000lists |> 
  mutate(
    mode = ifelse(mode == 0, "Minor", "Major")) |>
  ggplot(
    aes(
      x = valence,
      y = danceability,
      colour = mode,
      text = track.name)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~category) +
   scale_x_continuous(
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),  
    minor_breaks = NULL    
  ) +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  theme_classic() +
  labs(
    x = "Valence",
    y = "Danceability",
    colour = "Mode",
  )

ggplotly(Top2000_scatter)
```

***
In this scatter plot you can see the relation between valence, danceability and mode in the TOP2000.

### How pitch makes Bohemian Rhapsody number 1 {.storyboard}

```{r}
Bohemian <- 
  get_tidy_audio_analysis("4u7EnebtmKWzUH433cf5Qv") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

Bohemian_chromagram <- Bohemian |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

ggplotly(Bohemian_chromagram)
```

***
Let's first look at Bohemian Rhapsody by Queen. This is definitely an interesting song in the TOP2000. From the first year onwards it has been number 1 for almost all years. What makes the song so great? If we look at pitch in the form of the chromagram we can perhaps see why. The song is in three different keys. It starts in the key of Bb in the verse, which becomes very clear by the yellow stripes in the chromagram. Another important moment in the song is the so-called 'opera'-part. This happens around 3 minutes, (or 180 seconds) and is visible in the chromagram if you look at the greener area in the key of A. The greener area in A can be explained because this part is starting in A-major and the part modulates back and forth to this key. The song ends in the key of Eb, hence the yellow area around 330s. In general, you could say this song is all over the place pitch-wise because it is changing key often (I have only outlined the big changes, a lot more is happening!).

### Who Wants to Live Forever might be the saddest song in the TOP2000 {.storyboard}

#### Chromagram
```{r}
WWTLF1 <- 
  get_tidy_audio_analysis("3SGP8It5WDnCONyApJKRTJ") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

WWTLF1_chromagram <- WWTLF1 |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

ggplotly(WWTLF1_chromagram)
```

#### Cepstrogram
```{r}
WWTLF2 <-
  get_tidy_audio_analysis("3SGP8It5WDnCONyApJKRTJ") |>
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

WWTLF2_cepstrogram <- WWTLF2 |>
  compmus_gather_timbre() |>
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()

ggplotly(WWTLF2_cepstrogram)
```

#### Self-Similarity Matrix Pitch
```{r}
WWTLF1 |>
  compmus_self_similarity(pitches, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```

#### Self-Similarity Matrix Timbre
```{r}
WWTLF2 |>
  compmus_self_similarity(timbre, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```

***
Another interesting song by Queen in the TOP2000 is Who Wants to Live Forever. This song turned out to be an outlier in the scatter plot by having a low valence score and a low danceability score. That makes the song perhaps the saddest in the TOP2000. From the chromagram, cepstrogram and the two self-similarity matrices it becomes more clear how the song is built. 
In the chromagram you can see that there is a lot of E, which can be explained by the key of the song. The E-minor scale consists of E F# G A B C D, therefore it is no surprise that the chromagram shows a higher magnitude for these tones.
The cepstrogram gives more information about the timbre of this song. There is not too much variety in timbre, c02 is relatively yellow through almost the entire song, however c01 till c06 show some magnitude.
The self-similarity matrices explain the structure of the song. In both matrices there are some clear distinctions visible between parts of the song. For example around 85 seconds, the moment when the chorus starts, there is a sharp change in both matrices.

### The rising star of the last decade: Fix You {.storyboard}

#### Chromagram {data-commentary-width=400}
```{r}
FixYou1 <- 
  get_tidy_audio_analysis("7LVHVU3tWfcxj5aiPFEW4Q") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

FixYou1_chromagram <- FixYou1 |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

ggplotly(FixYou1_chromagram)
```

#### Cepstrogram {data-commentary-width=400}
```{r}
FixYou2 <-
  get_tidy_audio_analysis("7LVHVU3tWfcxj5aiPFEW4Q") |>
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

FixYou2_cepstrogram <- FixYou2 |>
  compmus_gather_timbre() |>
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()

ggplotly(FixYou2_cepstrogram)
```

#### Self-Similarity Matrix Pitch {data-commentary-width=400}
```{r}
FixYou1 |>
  compmus_self_similarity(pitches, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")

FixYou2 |>
  compmus_self_similarity(timbre, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```

***
Queen is not the only band in the TOP2000 who has a big impact on the list. Coldplay has turned out to also be a favourite over the past few years. Their song Fix You ended on the 5th place in the edition of 2022.
The chromagram is evident with separately showing the chords that are being played at the start. The song begins with an organ that plays Eb Gm Cm7 Gb, as is also shown in the chromagram. From around 150 seconds these individually played chords fade away and make way for other patterns with a high magnitude at Eb, the key of the song.
There is not much variety of timbre in Fix You, as is shown in the cepstrogram. The highest magnitudes lie at C01 to C03 throughout the entire song. In the first half of the song there are lower magnitudes up till C08, however after approximately 150 seconds, in the second half of the song, only C06 is left of these.
Even though the self-similarity matrix for pitch is not too clear, with the help of the self-similarity matrix for timbre there is still some information to get from it. The most obvious change in both matrices happens around 150 seconds, this is the moment the guitar solo starts. The self-similarity matrix for timbre shows another change about 30 seconds later, the moment the drums kick in. Although it's not very obvious, the self-similarity matrix reveal the repetition of the chorus with a chessboard-like pattern at 70-90 seconds, 130-150 seconds and 260-280 seconds.

### Timbre in the Top 2000 {.storyboard}
```{r}
Top1999timbre <-
  get_playlist_audio_features(
    "thesoundsofspotify",
    "55s8gstHcaCyfU47mQgLrB"
  ) |>
  slice(1:100) |>
  add_audio_analysis()
Top2009timbre <-
  get_playlist_audio_features(
    "thesoundsofspotify",
    "2cjIvuw4VVOQSeUAZfNiqY"
  ) |>
  slice(1:100) |>
  add_audio_analysis()
Top2019timbre <-
  get_playlist_audio_features(
    "thesoundsofspotify",
    "1MaaUHHVuXbmrDhoUCDDcL"
  ) |>
  slice(1:100) |>
  add_audio_analysis()
Top2022timbre <-
  get_playlist_audio_features(
    "thesoundsofspotify",
    "4U5UXciYphLDZAIgjdz50v"
  ) |>
  slice(1:100) |>
  add_audio_analysis()
Top2000timbre <-
  bind_rows(
   Top1999timbre |> mutate(year = "1999"),
   Top2009timbre |> mutate(year = "2009"),
   Top2019timbre |> mutate(year = "2019"),
   Top2022timbre |> mutate(year = "2022")
  )
```

```{r, fig.width=10, fig.height=4}
Top2000timbre |>
  mutate(
    timbre =
      map(
        segments,
        compmus_summarise,
        timbre,
        method = "mean"
      )
  ) |>
  select(year, timbre) |>
  compmus_gather_timbre() |>
  ggplot(aes(x = basis, y = value, fill = year)) +
  geom_violin() +
  scale_fill_viridis_d() +
  labs(x = "Spotify Timbre Coefficients", y = "", fill = "Year")
```

***
This plot shows the timbre values from 3 years of the TOP 2000. Only the first 100 songs of the playlists are used for this plot. A few timbre coefficients show differences between the four years. For example c02, c04, c06 and c012. In c06 the year of 2009 stands out, the violin has a much longer shape compared to the other years. The same is true for c12 where 1999 has a longer and different shape than the other years. The violins of 2019 and 2022 are very alike for all of the timbre coefficients. This might be because there are only 3 years in between. It means that the first 100 songs in these playlists "sound" relatively the same.

### Hey Jude {.storyboard}

#### Keygram {data-commentary-width=400}
```{r}
Jude <-
  get_tidy_audio_analysis("3m7V717IKZqZLW5qUIOxdD") |>
  compmus_align(sections, segments) |>
  select(sections) |>
  unnest(sections) |>
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

Jude |> 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) |>
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")
```

***
The keygram is shown for Hey Jude by the Beatles. According to the keygram the key of the song changes a few times. it looks like the song starts with a short intro in A-minor and then moves to the key of F-major. After this there are two quick changes, the first of which is to Bb-minor or Bb-major. The keygram shows the same magnitude for these keys but it would make more sense that it's Bb-major because this key is closer related to the previous keys. After this the key goes back to F-major and then to the dominant of F, the C-major. The remaining part of the song the key changes between these two keys, the F-major and the C-major. Even though most of the key changes aren't that surprising, the fact that there are several changes makes it interesting to listen to. 

#### Chordogram {data-commentary-width=400}
```{r}
Jude2 <-
  get_tidy_audio_analysis("1eT2CjXwFXNx6oY5ydvzKU") |>
  compmus_align(bars, segments) |>
  select(bars) |>
  unnest(bars) |>
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

Jude2 |> 
  compmus_match_pitch_template(
    chord_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) |>
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")
```

***
The first chords of Hey Jude are clearly visible in the chordogram. These are F-maj, C-maj, F-maj and BB-maj. These chords aren't very surprising because they are the I, V and IV.

### Loudness, tempo and duration {.storyboard}
```{r}
Top2000timbre |>
  mutate(
    sections =
      map(
        sections,                                    # sections or segments
        summarise_at,
        vars(tempo, loudness, duration),             # features of interest
        list(section_mean = mean, section_sd = sd)   # aggregation functions
      )
  ) |>
  unnest(sections) |>
  ggplot(
    aes(
      x = tempo,
      y = tempo_section_sd,
      colour = year,
      alpha = loudness,
      text = track.name
    )
  ) +
  geom_point(aes(size = duration / 60)) +
  geom_rug() +
  theme_light() +
  ylim(0, 5) +
  labs(
    x = "Mean Tempo (bpm)",
    y = "SD Tempo",
    colour = "Year",
    size = "Duration (min)",
    alpha = "Volume (dBFS)"
  )

```

***
This plot shows the loudness tempo and duration of the first 100 songs in four years in the TOP2000.

Conclusion
=================================================
